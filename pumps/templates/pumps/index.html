{% load static %}

<!doctype html>
<html lang="ro">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Monitoring Pompe</title>

    <style>
        :root{
            --bg:#f8f9fa;          /* —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∫ —É –≥—Ä–∞—Ñ–∏–∫–∞ (light) */
            --text:#212529;
            --muted:#6b7280;
            --line:#dee2e6;

            --nav-bg:#7291bf;      /* navbar –∫–∞–∫ —É –≥—Ä–∞—Ñ–∏–∫–∞ (light) */

            --g:#35d21b;
            --r:#d21b1b;
            --y:#f0c419;
            --gr:#bdbdbd;
        }

        body.dark{
            --bg:#495057;          /* —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∫ —É –≥—Ä–∞—Ñ–∏–∫–∞ (dark) */
            --text:#f8f9fa;
            --muted:#9ca3af;
            --line:#495057;

            --nav-bg:#343a40;      /* navbar –∫–∞–∫ —É –≥—Ä–∞—Ñ–∏–∫–∞ (dark) */
        }

        body{
          font-family: Arial, sans-serif;
          padding: 12px 14px;
          background: var(--bg);
          color: var(--text);
          font-size: 15px;
        }

        /* ===== Toolbar ===== */
        .toolbar{
            position: relative;
            display:flex;
            justify-content: center; /* T2 –ø–æ —Ü–µ–Ω—Ç—Ä—É */
            align-items:center;
            gap:12px;
            margin: 6px 0 12px;
        }

        .toolbar label{
          display:flex;
          align-items:center;
          gap:6px;
          font-size: 14px;
        }

        input[type="number"]{
          height: 26px;
          width: 80px;
          padding: 0 6px;
          border:1px solid var(--line);
          border-radius: 6px;
          font-size: 14px;
          outline:none;
          text-align:center;
          background: var(--bg);
          color: var(--text);
        }

        /* –∫–Ω–æ–ø–∫–∞ —Ç–µ–º—ã */
        #themeBtn{
            position: absolute;
            right: 0;          /* üëâ –≤ —Å–∞–º—ã–π –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π */
            height:26px;
            padding:0 10px;
            border-radius:6px;
            border:1px solid var(--line);
            background:var(--bg);
            color:var(--text);
            cursor:pointer;
        }
        #themeBtn:hover{
          background: rgba(0,0,0,0.05);
        }
        body.dark #themeBtn:hover{
          background: rgba(255,255,255,0.08);
        }

        /* ===== Grid ===== */
        .grid{
          display:grid;
          gap: 2px;
          grid-template-columns: repeat(4, minmax(220px, 1fr));
          align-items:start;
        }
        @media (max-width: 1200px){
          .grid{ grid-template-columns: repeat(2, minmax(220px, 1fr)); }
        }
        @media (max-width: 700px){
          .grid{ grid-template-columns: 1fr; }
        }

        .card{
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 6px 6px 5px;
            background: var(--bg);
            box-shadow: 0 1px 0 rgba(0,0,0,0.02);
        }

        /* ===== –¶–≤–µ—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–¥–µ–Ω—å) ===== */
        .grid > .card:nth-child(1){
          background: #f8fbff;
          border-color: #dbeafe;
        }
        .grid > .card:nth-child(2){
          background: #f9fff8;
          border-color: #dcfce7;
        }
        .grid > .card:nth-child(3){
          background: #fffaf5;
          border-color: #ffedd5;
        }
        .grid > .card:nth-child(4){
          background: #fff8fb;
          border-color: #fce7f3;
        }

        /* ===== –¶–≤–µ—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ω–æ—á—å) ===== */
        body.dark .grid > .card:nth-child(1){
            background: #0f1a2b;
            border-color: #1e3a8a;
        }
        body.dark .grid > .card:nth-child(2){
            background: #0f2418;
            border-color: #166534;
        }
        body.dark .grid > .card:nth-child(3){
            background: #0f1a2b;
            border-color: #1e3a8a;
        }
        body.dark .grid > .card:nth-child(4){
            background: #0f2418;
            border-color: #166534;
        }

        .head{
          display:grid;
          grid-template-columns: 72px 60px 64px 64px;
          gap: 8px;
          padding: 4px 6px 6px;
          font-size: 13px;
          font-weight: 800;
          border-bottom: 1px solid var(--line);
          margin-bottom: 6px;
        }
        .head > div:nth-child(3),
        .head > div:nth-child(4){
          text-align:right; /* –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–∞–∫ –µ—Å—Ç—å */
        }

        .row{
          display:grid;
          grid-template-columns: 72px 60px 64px 64px;
          gap: 8px;
          align-items:center;
          padding: 4px 6px;
          border-radius: 8px;
        }
        .row:hover{ background: rgba(0,0,0,0.05); }
        body.dark .row:hover{ background: rgba(255,255,255,0.06); }

        .pumps{
          display:flex;
          align-items:center;
          gap: 4px;
          min-height: 18px;
          width:80px;
        }
        .sq{
          width: 24px;
          height: 24px;
          display:inline-block;
          border:1px solid #222;
          border-radius: 2px;
          background: var(--gr);
        }
        .sq.g{ background: var(--g); }
        .sq.r{ background: var(--r); }
        .sq.y{ background: var(--y); }
        .sq.gr{ background: var(--gr); }

        /* ===== armed (–ü–ö–ú: –∫–≤–∞–¥—Ä–∞—Ç -> –∫—Ä—É–≥) ===== */
        .sq.armed{
          border-radius: 50% !important;
          box-shadow: 0 0 0 2px rgba(255,255,255,.45) inset;
        }
        body.dark .sq.armed{
          box-shadow: 0 0 0 2px rgba(255,255,255,.35) inset;
        }

        .ptc{
          font-weight: 800;
          font-size: 15px;
        }

        /* –∑–Ω–∞—á–µ–Ω–∏—è T2/Q –¥–æ–ª–∂–Ω—ã —Ä–æ–≤–Ω–æ —Å—Ç–∞—Ç—å –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ */
        .val{
          font-size: 15px;
          text-align:right;            /* –≤–∞–∂–Ω–æ: –∫–∞–∫ —É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
          justify-self:end;            /* –≤–∞–∂–Ω–æ –¥–ª—è grid */
          font-variant-numeric: tabular-nums;
        }
        .val a{
          display:block;               /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –º–∏–∫—Ä–æ—Å–¥–≤–∏–≥–æ–≤ */
          text-align: inherit;
        }

        .t2-alert{
          color: var(--r);
          font-weight: 900;
        }

        a{
          color: inherit;
          text-decoration:none;
        }
        a:hover{ text-decoration: underline; }

        /* 2-—è –∫–∞—Ä—Ç–æ—á–∫–∞: –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –¥–ª—è 3-—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ */
        .grid > .card:nth-child(2) .head{
          grid-template-columns: 84px 60px 64px 64px;
        }
        .grid > .card:nth-child(2) .row{
          grid-template-columns: 84px 60px 64px 64px;
        }
        .grid > .card:nth-child(2) .pumps{
          width:84px;
        }

        /* ===== –ö–ù–û–ü–ö–ê –¢–ï–ú–´ (bootstrap-like) ===== */
        .btn-theme{
            position: absolute;
            right: 0;
            height:26px;
            padding: 0 10px;
            border-radius: 6px;
            background: transparent;
            border: 1px solid var(--line);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
        }
        .btn-theme:hover{
            background: rgba(0,0,0,0.06);
        }
        body.dark .btn-theme:hover{
            background: rgba(255,255,255,0.08);
        }

        .toolbar{
            position: relative;
            display:flex;
            align-items:center;
            margin: 6px 0 12px;
        }

        /* —Ü–µ–Ω—Ç—Ä —ç–∫—Ä–∞–Ω–∞ */
        .t2-controls{
            margin: 0 auto;
            display:flex;
            gap:12px;
        }

        /* –∫–Ω–æ–ø–∫–∞ —Ç–µ–º—ã —Å–ø—Ä–∞–≤–∞ */
        .btn-theme{
            position: absolute;
            right: 0;
            height:26px;
            padding:0 10px;
            border-radius:6px;
            border:1px solid var(--line);
            background:transparent;
            color:var(--text);
            cursor:pointer;
            font-size:13px;
        }
        .btn-theme:hover{
            background: rgba(0,0,0,0.06);
        }
        body.dark .btn-theme:hover{
            background: rgba(255,255,255,0.08);
        }

        /* ===== TOP BAR (–∫–∞–∫ navbar —É –≥—Ä–∞—Ñ–∏–∫–∞) ===== */
        .toolbar{
            background: var(--nav-bg);
            padding: 10px 12px;
            border-radius: 10px;
            margin: 6px 0 12px;        /* –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–≤–æ–∏ –æ—Ç—Å—Ç—É–ø—ã –ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–∞–∫–∏–º–∏ –∂–µ */
        }

        /* –¢–µ–∫—Å—Ç –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –±–µ–ª—ã–π, –∫–∞–∫ –≤ –≥—Ä–∞—Ñ–∏–∫–µ */
        .toolbar,
        .toolbar label{
            color: rgba(255,255,255,.90);
        }

        /* –ü–æ–ª—è T2 min/max —á–∏—Ç–∞–µ–º—ã–µ –Ω–∞ —Ü–≤–µ—Ç–Ω–æ–π —à–∞–ø–∫–µ */
        .toolbar input[type="number"]{
            background:#ffffff;
            color:#111;
            border:1px solid rgba(255,255,255,.55);
        }
        body.dark .toolbar input[type="number"]{
            background:#212529;
            color:#f8f9fa;
            border:1px solid rgba(255,255,255,.25);
        }

        /* ===== SCADA Portal –∫–∞–∫ –≤ –≥—Ä–∞—Ñ–∏–∫–µ (outline-light) ===== */
        .btn{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:.25rem;
            text-decoration:none;
            cursor:pointer;
            user-select:none;
            white-space:nowrap;
        }

        .btn-sm{
            height:26px;
            padding:0 10px;
            border-radius:6px;
            font-size:13px;
            line-height:1;
        }

        .btn-outline-light{
            color:#fff;
            background:transparent;
            border:1px solid rgba(255,255,255,.85);
        }

        .btn-outline-light:hover{
            background:#fff;
            color:#111;
            text-decoration:none;
        }

        /* ===== –ö–Ω–æ–ø–∫–∞ —Ç–µ–º—ã —Å–ø—Ä–∞–≤–∞ ‚Äî —Ç–æ–∂–µ –∫–∞–∫ outline-light ===== */
        .btn-theme{
            border:1px solid rgba(255,255,255,.85) !important;
            color:#fff !important;
            background:transparent !important;
        }

        .btn-theme:hover{
            background: rgba(255,255,255,0.15) !important;
        }
    </style>
</head>

<body>

<div class="toolbar">

    <!-- –°–õ–ï–í–ê: SCADA Portal -->
    <div class="left-tools d-flex align-items-center gap-2">
        <a href="http://10.1.1.248:1010/"
           class="btn btn-outline-light btn-sm"
           target="_blank"
           rel="noopener">
            SCADA Portal
        </a>
    </div>

    <!-- –¶–ï–ù–¢–†: T2 min / max -->
    <div class="t2-controls">
        <label>T2 min <input id="t2min" type="number" value="10"></label>
        <label>T2 max <input id="t2max" type="number" value="55"></label>
    </div>

    <!-- –°–ü–†–ê–í–ê: —Ç–µ–º–∞ -->
    <button id="btn-theme" class="btn-theme" title="TemƒÉ">‚òÄÔ∏è/üåô</button>

</div>

<div class="grid" id="grid"></div>

<!-- Alarm audio (loop). –í Django /static/sonor.mp3 –¥–æ–ª–∂–µ–Ω –æ—Ç–¥–∞–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ STATIC_URL -->
<audio id="alarm-audio" preload="auto" loop src="{% static 'sonor.wav' %}"></audio>


<script>
    const grid = document.getElementById("grid");
    const t2minEl = document.getElementById("t2min");
    const t2maxEl = document.getElementById("t2max");
    const themeBtn = document.getElementById("btn-theme");

    // ===== Persist armed state (–∫–∞–∫ –≤–æ –≤—Ç–æ—Ä–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏) =====
    const LS_ARMED = 'ui.pumps.armed';

    function loadArmedFromLS(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS_ARMED) || '[]');
        return new Set(Array.isArray(arr) ? arr : []);
      }catch{
        return new Set();
      }
    }

    function saveArmedToLS(set){
      try{
        localStorage.setItem(LS_ARMED, JSON.stringify([...set]));
      }catch{}
    }

    const armedPumpKeys = loadArmedFromLS();

    function pumpKey(ptc, pidx){
      return `${String(ptc ?? 'unknown')}:${String(pidx ?? '0')}`;
    }

    // ===== ALARM: –∫–∞–∫ –≤–æ 2-–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (—Å—Ç–∞—Ä—Ç –¢–û–õ–¨–ö–û –æ—Ç –ü–ö–ú –ø–æ –∫—Ä–∞—Å–Ω–æ–º—É) =====
    const alarmAudio = document.getElementById('alarm-audio');
    alarmAudio.volume = 0.8;

    let alarmPlaying = false;

    function hasAnyArmedRed(){
      // –ø—Ä–æ–≤–µ—Ä—è–µ–º DOM: –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω –Ω–∞—Å–æ—Å armed + –∫—Ä–∞—Å–Ω—ã–π
      return !!document.querySelector('.sq.armed.r');
    }

    function startAlarm(){
      if (alarmPlaying) return;
      alarmAudio.play().then(() => {
        alarmPlaying = true;
      }).catch(() => {
        // –ü–ö–ú ‚Äî —ç—Ç–æ user gesture, –æ–±—ã—á–Ω–æ play() —Ä–∞–∑—Ä–µ—à—ë–Ω.
      });
    }

    function stopAlarm(){
      if (!alarmPlaying) return;
      alarmAudio.pause();
      alarmAudio.currentTime = 0;
      alarmPlaying = false;
    }

    // ---- theme toggle ----
    themeBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      themeBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
    });

    let timerId = null;
    let inFlight = false;
    let lastData = [];

    // ===== –û–ö–†–£–ì–õ–ï–ù–ò–ï –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø =====
    function roundInt(x){
      const n = Number(x);
      if (Number.isNaN(n)) return String(x ?? "");
      return String(Math.round(n));   // T2 -> —Ü–µ–ª–æ–µ
    }

    function round2(x){
      const n = Number(x);
      if (Number.isNaN(n)) return String(x ?? "");
      return n.toFixed(2);            // Q -> 2 –∑–Ω–∞–∫–∞
    }

    function pumpSquareColor(v, isDigital01, lcs){
      if (isDigital01){
        if (v === 0) return "g";
        if (v === 1) return "r";
        return "gr";
      } else {
        if (lcs !== null && lcs < 30) return "y";
        if (v > 200) return "r";
        if (v > 0) return "g";
        return "gr";
      }
    }

    function makeLink(nodeOrText, url){
      if (!url){
        if (typeof nodeOrText === "string") return document.createTextNode(nodeOrText);
        if (nodeOrText instanceof Node) return nodeOrText;
        return document.createTextNode(String(nodeOrText ?? ""));
      }
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      if (typeof nodeOrText === "string") a.textContent = nodeOrText;
      else a.appendChild(nodeOrText);
      return a;
    }

    function pumpUrlByNum(row, n){
      if (n === 1) return row.url_pompa || null;
      if (n === 2) return row.url_pompa2 || null;
      if (n === 3) return row.url_pompa3 || null;
      return null;
    }

    function districtLabel(){ return ""; }

    function districtKeyFromPtc(ptc){
      const s = String(ptc ?? "").trim();
      if (!s) return null;
      const first = s[0];
      if (first === "1") return "2";
      if (first === "2" || first === "3" || first === "4" || first === "5") return first;
      return null;
    }

    function sortByPtcAsc(a, b){
      const aa = parseInt(String(a.ptc ?? "0"), 10);
      const bb = parseInt(String(b.ptc ?? "0"), 10);
      if (Number.isNaN(aa) && Number.isNaN(bb)) return 0;
      if (Number.isNaN(aa)) return 1;
      if (Number.isNaN(bb)) return -1;
      return aa - bb;
    }

    function buildCard(title, rows){
      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "head";
      head.innerHTML = `<div>Pompe</div><div>PTC</div><div>T2,¬∞C</div><div>Q,Gcal</div>`;
      card.appendChild(head);

      const t2min = Number(t2minEl.value);
      const t2max = Number(t2maxEl.value);

      for (const r of rows){
        const rowEl = document.createElement("div");
        rowEl.className = "row";

        const pumpsWrap = document.createElement("div");
        pumpsWrap.className = "pumps";

        const pumps = r.pompa || [];
        const nums  = r.pompa_nums || [];
        const isDigital01 = pumps.length > 0 && pumps.every(v => v === 0 || v === 1);
        const lcs = (r.lcs === null || r.lcs === undefined) ? null : Number(r.lcs);

        // ===== –ü–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—Å–æ—Å–æ–≤ (–ü–ö–ú: armed) + ALARM (–∫–∞–∫ –≤–æ 2-–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏) =====
        for (let i = 0; i < pumps.length; i++){
          const v = Number(pumps[i]);
          const num = nums[i] ?? null;

          const pidx = (num != null) ? Number(num) : (i + 1);

          // LOVATI: –≤ —Ä–µ–∂–∏–º–µ 0/1 —Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ 0 –∏–ª–∏ 1 (–∫–∞–∫ –≤–æ –≤—Ç–æ—Ä–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
          if (isDigital01 && !(v === 0 || v === 1)) {
            continue;
          }

          const sq = document.createElement("span");
          sq.className = "sq " + pumpSquareColor(v, isDigital01, lcs);

          // –∫–ª—é—á –Ω–∞—Å–æ—Å–∞ = PTC + –Ω–æ–º–µ—Ä –Ω–∞—Å–æ—Å–∞
          const key = pumpKey(r.ptc, pidx);

          // –ø—Ä–∏–º–µ–Ω—è–µ–º armed –∏–∑ localStorage
          if (armedPumpKeys.has(key)) {
            sq.classList.add('armed');
          }

          // –ü–ö–ú: toggle armed –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ + –∑–≤—É–∫ (—Å—Ç–∞—Ä—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –ü–ö–ú –ø–æ –∫—Ä–∞—Å–Ω–æ–º—É)
          sq.oncontextmenu = (e) => {
            e.preventDefault();
            e.stopPropagation();

            const wasArmed = sq.classList.contains('armed');

            if (wasArmed) {
              // —Ä–∞–∑–æ—Ä—É–∂–∞–µ–º
              sq.classList.remove('armed');
              armedPumpKeys.delete(key);
              saveArmedToLS(armedPumpKeys);

              // –µ—Å–ª–∏ –ø–æ—Å–ª–µ —Ä–∞–∑–æ—Ä—É–∂–µ–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ—Ç armed+–∫—Ä–∞—Å–Ω—ã—Ö ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
              if (!hasAnyArmedRed()) stopAlarm();

            } else {
              // –≤–æ–æ—Ä—É–∂–∞–µ–º
              sq.classList.add('armed');
              armedPumpKeys.add(key);
              saveArmedToLS(armedPumpKeys);

              // –∑–≤—É–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ –º–æ–º–µ–Ω—Ç –ü–ö–ú –∫–≤–∞–¥—Ä–∞—Ç –∫—Ä–∞—Å–Ω—ã–π
              if (sq.classList.contains('r')) startAlarm();
            }

            return false;
          };

          const url = num ? pumpUrlByNum(r, Number(num)) : null;
          pumpsWrap.appendChild(makeLink(sq, url));
        }

        const ptcEl = document.createElement("div");
        ptcEl.className = "ptc";
        ptcEl.appendChild(makeLink(String(r.ptc ?? ""), r.url_ptc));

        const t2El = document.createElement("div");
        t2El.className = "val";
        t2El.appendChild(makeLink(roundInt(r.t2), r.url_t2)); // T2 -> —Ü–µ–ª–æ–µ

        const t2val = Number(r.t2);
        if (!Number.isNaN(t2val) && !Number.isNaN(t2min) && !Number.isNaN(t2max)) {
          if (t2val < t2min || t2val > t2max) t2El.classList.add("t2-alert");
        }

        const qEl = document.createElement("div");
        qEl.className = "val";
        qEl.appendChild(makeLink(round2(r.q1), r.url_q1));    // Q -> 2 –∑–Ω–∞–∫–∞

        rowEl.appendChild(pumpsWrap);
        rowEl.appendChild(ptcEl);
        rowEl.appendChild(t2El);
        rowEl.appendChild(qEl);
        card.appendChild(rowEl);
      }
      return card;
    }

    function render(data){
      grid.innerHTML = "";
      const buckets = { "2": [], "3": [], "4": [], "5": [] };

      for (const r of data){
        const k = districtKeyFromPtc(r.ptc);
        if (!k) continue;
        buckets[k].push(r);
      }

      for (const k of Object.keys(buckets)){
        buckets[k].sort(sortByPtcAsc);
      }

      const order = ["2","3","4","5"];
      for (const k of order){
        grid.appendChild(buildCard("", buckets[k]));
      }

      // –í–∞–∂–Ω–æ: –º—ã –ù–ï –≤–∫–ª—é—á–∞–µ–º –∑–≤—É–∫ —Å–∞–º–∏ –ø—Ä–∏ render().
      // –°—Ç–∞—Ä—Ç —Ç–æ–ª—å–∫–æ –æ—Ç –ü–ö–ú –ø–æ –∫—Ä–∞—Å–Ω–æ–º—É (–∫–∞–∫ –≤–æ –≤—Ç–æ—Ä–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏).
      // –ù–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –∏ –∫—Ä–∞—Å–Ω—ã—Ö armed –±–æ–ª—å—à–µ –Ω–µ—Ç ‚Äî –≤—ã–∫–ª—é—á–∏–º –∑–≤—É–∫.
      if (!hasAnyArmedRed()) stopAlarm();
    }

    async function load(){
      if (inFlight) return;
      inFlight = true;
      try{
        const url = new URL("/pumps/api/table/", window.location.origin);
        if (t2minEl.value !== "") url.searchParams.set("t2_min", t2minEl.value);
        if (t2maxEl.value !== "") url.searchParams.set("t2_max", t2maxEl.value);
        const res = await fetch(url.toString(), { credentials: "same-origin", cache: "no-store" });
        const data = await res.json();
        lastData = Array.isArray(data) ? data : [];
        render(lastData);
      } catch(e){
        console.error("Load error:", e);
      } finally {
        inFlight = false;
      }
    }

    function startAuto(){
      if (timerId) clearInterval(timerId);
      timerId = setInterval(load, 30000);
    }

    t2minEl.addEventListener("input", load);
    t2maxEl.addEventListener("input", load);

    load();
    startAuto();
</script>

</body>
</html>
