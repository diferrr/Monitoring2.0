<!DOCTYPE html>
<html lang="ro">
<head>
    {% load static %}
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>TERMOELECTRICA S.A.</title>

    <!-- Leaflet & MarkerCluster CSS -->
    <link
            href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            rel="stylesheet"
    />
    <link
            href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
            rel="stylesheet"
    />
    <link
            href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
            rel="stylesheet"
    />

    <!-- JQuery & Leaflet JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    {% load static %}
    <script src="{% static 'sectors.js' %}"></script>

    <style>
        body {
     font-family: Arial, sans-serif;
     text-align: center;
     background-color: #f4f4f4;
     margin: 0;
     padding: 0;
 }
 .header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     width: 100vw;
     max-width: none;
     margin: 0;
     position: fixed;
     top: 0;
     left: 0;
     z-index: 10;
     background: rgba(244, 244, 244, 0.98);
     padding: 18px 0 5px 0;
 }
 h1 {
     color: #2c3e50;
     margin: 0;
     text-align: left;
     padding-left: 30px;
 }
 #search-container {
     position: absolute;
     top: 22px;
     right: 40px;
     z-index: 11;
     text-align: right;
 }
 #sector-buttons {
     display: flex;
     justify-content: center;
     gap: 15px;
     flex-wrap: wrap;
     margin: 0;
     position: fixed;
     top: 70px; /* –Ω–∏–∂–µ —à–∞–ø–∫–∏ */
     left: 0;
     width: 100vw;
     z-index: 10;
     background: none;
 }
 #map {
     position: fixed;
     top: 0;
     left: 0;
     right: 0;
     bottom: 0;
     width: 100vw;
     height: 100vh;
     z-index: 1;
     border: none;
     border-radius: 0;
     box-shadow: none;
     margin: 0;
     max-width: none;
 }
 #limits-box, #limits-tooltip, #status-filter, #status-list {
     position: fixed;
     z-index: 12;
 }
 #limits-box {
     top: 110px;
     left: 20px;
     width: 35px;
     height: 35px;
     font-size: 23px;
     background-color: #32d74b;
     color: #fff;
     font-weight: bold;
     text-align: center;
     line-height: 50px;
     border-radius: 10px;
     box-shadow: 0 0 7px rgba(0,0,0,0.28);
     border: 2.5px solid #149c21;
     cursor: pointer;
     transition: background 0.15s, box-shadow 0.2s;
 }
 #limits-box:hover {
     background-color: #23b037;
     box-shadow: 0 0 15px #32d74b99;
 }
 #limits-tooltip {
     top: 130px;
     left: 60px;
 }
 #status-filter {
     top: 150px;
     left: 20px;
     display: flex;
     flex-direction: column;
     gap: 22px;
     z-index: 1002;
     /* –æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –∫—Ä—É–ø–Ω–µ–µ —Ç–µ–∫—Å—Ç–∞ */
     font-size: 20px;
     font-weight: bold;
     color: #333;
     line-height: 1.4;
 }
 #status-filter > div > div:not(.filter-icon) {
     font-size: 19px;
     font-weight: bold;
     color: #2c2c2c;
     margin-left: 8px;
 }
 #status-list {
     top: 150px;
     left: 60px;
 }

 /* --------- –î–ê–õ–ï–ï –¢–í–û–ò –°–¢–ê–†–´–ï –°–¢–ò–õ–ò, –∏—Ö –Ω–µ —Ç—Ä–æ–≥–∞–π --------- */

 #search-box {
     padding: 8px;
     width: 200px;
     border: 1px solid #ccc;
     border-radius: 4px;
 }
 #search-button {
     padding: 8px 15px;
     background-color: #2c3e50;
     color: white;
     border: none;
     border-radius: 4px;
     cursor: pointer;
 }
 #search-button:hover {
     background-color: #1a252f;
 }
 #sector-buttons button {
     padding: 5px 30px;
     font-size: 16px;
     font-weight: bold;
     background: linear-gradient(180deg, #222 0%, #000 100%);
     border: 3px solid #bbb;
     border-radius: 50px;
     color: #fff;
     text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
     cursor: pointer;
     box-shadow:
         0 4px 10px rgba(0, 0, 0, 0.8),
         inset 0 2px rgba(255, 255, 255, 0.3),
         inset 0 -2px 3px rgba(0, 0, 0, 0.6);
     transition: all 0.3s ease;
 }
 #sector-buttons button.active {
     background: linear-gradient(180deg, #444 0%, #111 100%);
     border-color: green;
     box-shadow:
         0 6px 15px rgba(0, 0, 0, 0.9),
         inset 0 3px rgba(255, 255, 255, 0.5),
         inset 0 -3px 4px rgba(0, 0, 0, 0.7);
     transform: scale(1.02);
 }
 #sector-buttons button:hover {
     background: linear-gradient(180deg, #333 0%, #111 100%);
     transform: scale(1.05);
     border-color: white;
 }
 .hidden {
     display: none;
 }
 .filter-icon {
     width: 34px; /* —Å—Ç–∞–ª–æ —á—É—Ç—å –±–æ–ª—å—à–µ */
     height: 34px;
     border-radius: 50%;
     cursor: pointer;
     border: 2px solid #333;
 }
 #status-list {
     background: #fff;
     padding: 10px;
     border: 1px solid #999;
     border-radius: 6px;
     box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
     z-index: 1003;
     max-height: 300px;
     overflow-y: auto;
     font-size: 15px;
     text-align: left;
 }
 #status-list div {
     cursor: pointer;
     padding: 4px 0;
     border-bottom: 1px solid #eee;
 }
 #status-list div:hover {
     background-color: #f0f0f0;
 }

  /* –±–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–≤–æ–µ–π –∏–∫–æ–Ω–∫–∏ 48x48 */
   .station-ico {
     width: 48px;
     height: 48px;
     position: relative;
     border: 2px solid black;
     border-radius: 6px;
     box-shadow: 0 0 5px rgba(0,0,0,0.5);
     overflow: hidden;
     background: rgba(255,255,255,0.75);
   }
   .station-ico img.base {
     width: 100%;
     height: 100%;
     object-fit: contain;
     display: block;
   }

   /* ========= SP: ‚Äú—Ä–æ—Ç–æ—Ä‚Äù –≤—Ä–∞—â–∞–µ—Ç—Å—è ========= */
   .station-ico.sp .rotor {
     position: absolute;
     /* –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ —Ä–æ—Ç–æ—Ä–∞ ‚Äî –º–æ–∂–Ω–æ —á—É—Ç—å –¥–≤–∏–≥–∞—Ç—å */
     left: 10px;
     top: 18px;
     width: 16px;
     height: 16px;
     border-radius: 50%;
     background:
       conic-gradient(
         rgba(255,255,255,0.95) 0 20%,
         rgba(0,0,0,0.2) 20% 25%,
         rgba(255,255,255,0.95) 25% 45%,
         rgba(0,0,0,0.2) 45% 50%,
         rgba(255,255,255,0.95) 50% 70%,
         rgba(0,0,0,0.2) 70% 75%,
         rgba(255,255,255,0.95) 75% 95%,
         rgba(0,0,0,0.2) 95% 100%
       );
     border: 1px solid rgba(0,0,0,0.35);
     animation: spin 0.9s linear infinite;
     opacity: 0.95;
   }
   @keyframes spin { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }

   /* ========= DISP: –º–∏–≥–∞—é—â–∞—è —Ç–æ—á–∫–∞ ========= */
   .station-ico.disp .blink {
     position:absolute;
     right: 4px;
     top: 4px;
     width: 10px;
     height: 10px;
     border-radius: 50%;
     background: #00ff3b;
     box-shadow: 0 0 8px rgba(0,255,60,0.9);
     animation: blink 1.1s ease-in-out infinite;
   }
   @keyframes blink { 0%,100%{opacity:.2} 50%{opacity:1} }

   /* ========= CT/CET: ‚Äú–¥—ã–º‚Äù (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å —á–µ—Ä–µ–∑ GIF) ========= */
   .station-ico.ct .smoke {
     position:absolute;
     left: 0;
     top: 0;
     width: 48px;
     height: 48px;
     pointer-events: none;
     opacity: 0.95;
   }


    </style>
</head>
<body>
<div class="header">
    <h1>Harta SinopticƒÉ</h1>
    <div id="search-container">
        <input
                id="search-box"
                list="search-history"
                placeholder="√éntroduce»õi Nr obiectului..."
                type="text"
        />
        <datalist id="search-history"></datalist>
        <button id="search-button">CAUTƒÇ</button>
    </div>
</div>

<div id="sector-buttons">
    <button data-sector="1">Centru</button>
    <button data-sector="2">RƒÉ»ôcani</button>
    <button data-sector="3">Botanica</button>
    <button data-sector="4">Buiucani</button>
    <button data-sector="6">Ciocana</button>
    <button data-sector="0">AratƒÉ Toate</button>
</div>

<div id="limits-box">L</div>
<div class="hidden" id="limits-tooltip">Loading...</div>

<div
        id="status-filter"
        style="
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
      "
>
    <div style="display: flex; flex-direction: column; align-items: center">
        <div
                class="filter-icon"
                data-color="red"
                style="background-color: red"
        ></div>
        <div style="font-size: 12px; color: #333; text-align: center">
            Temperatura ridicatƒÉ
        </div>
    </div>
    <div style="display: flex; flex-direction: column; align-items: center">
        <div
                class="filter-icon"
                data-color="green"
                style="background-color: green"
        ></div>
        <div style="font-size: 12px; color: #333; text-align: center">
            Temperatura √Æn normƒÉ
        </div>
    </div>
    <div style="display: flex; flex-direction: column; align-items: center">
        <div
                class="filter-icon"
                data-color="blue"
                style="background-color: blue"
        ></div>
        <div style="font-size: 12px; color: #333; text-align: center">
            Temperatura joasƒÉ
        </div>
    </div>
    <div style="display: flex; flex-direction: column; align-items: center">
        <div
                class="filter-icon"
                data-color="black"
                style="background-color: black"
        ></div>
        <div style="font-size: 12px; color: #333; text-align: center">
            Date expirate
        </div>
    </div>
</div>

<!--
<div id="status-filter">
<div
class="filter-icon"
data-color="red"
style="background-color: red"
title="AratƒÉ PTC/PTI care au depƒÉ»ôit limita de temperaturƒÉ"
></div>
<div
class="filter-icon"
data-color="green"
style="background-color: green"
title="AratƒÉ PTC/PTI al cƒÉrora  temperatura corespunde limitelor"
></div>
<div
class="filter-icon"
data-color="blue"
style="background-color: blue"
title="AratƒÉ PTC/PTI al cƒÉrora temperaturƒÉ este sub limitƒÉ"
></div>
<div
class="filter-icon"
data-color="black"
style="background-color: black"
title="AratƒÉ PTC/PTI ale cƒÉrora date sunt mai depƒÉ»ôite decƒÉt 15 minute "
></div>
</div>
-->

<div class="hidden" id="status-list"></div>

<div id="map"></div>

<script>
    const map = L.map("map").setView([47.01, 28.86], 12);

    window.pumpsLoaded = false;
    window.pipelinesLoaded = false;
    window.zadviscaLoaded = false;

    // —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–ª–æ–∏
    let heatPipelineLayer = null;
    let zadviscaLayer = null;

    // –õ–µ–Ω–∏–≤–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–ª–æ—ë–≤ –ø–æ –∑—É–º—É + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å–ª–æ—ë–≤
    map.on("zoomend", function () {
      const z = map.getZoom();

      // PTC/PTI
      if (!window.pumpsLoaded && z >= 12) {
        fetchAndRenderPumps();
      }

      // –¢–µ–ø–ª–æ—Ç—Ä–∞—Å—Å—ã (–≤–∏—Ç–∏–∫—é)
      if (!window.pipelinesLoaded && z >= 18) {
        fetchAndRenderPipelines();
      } else if (window.pipelinesLoaded && heatPipelineLayer) {
        if (z >= 18) {
          if (!map.hasLayer(heatPipelineLayer))
            map.addLayer(heatPipelineLayer);
        } else {
          if (map.hasLayer(heatPipelineLayer))
            map.removeLayer(heatPipelineLayer);
        }
      }

      // Zadvisca
      if (!window.zadviscaLoaded && z >= 18) {
        fetchAndRenderZadvisca();
      } else if (window.zadviscaLoaded && zadviscaLayer) {
        if (z >= 18) {
          if (!map.hasLayer(zadviscaLayer)) map.addLayer(zadviscaLayer);
        } else {
          if (map.hasLayer(zadviscaLayer)) map.removeLayer(zadviscaLayer);
        }
      }
    });

    const markers = L.markerClusterGroup({
      maxClusterRadius: 70,
      disableClusteringAtZoom: 17,
    });
    const pumpMarkers = {};
    const iconCache = {};
    let exteriorTemp = null;
    let limits = {};
    let lastBulkUpdate = 0;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
    }).addTo(map);

    //  –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª–∏–≥–æ–Ω–æ–≤ —Å–µ–∫—Ç–æ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
    const sectorPolygons = {};

    Object.entries(sectors).forEach(([sectorName, sectorData]) => {
      const polygon = L.polygon(sectorData.latlng, {
        color: sectorData.color,
        fillOpacity: 0.03,
        weight: 2,
      }).bindPopup(`<b>${sectorName}</b>`);

      sectorPolygons[sectorName] = polygon; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–∏–≥–æ–Ω—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

      polygon.addTo(map);
    });

    function getColoredIcon(name, color) {
      const key = `${name}_${color}`;
      if (!iconCache[key]) {
        iconCache[key] = L.divIcon({
          html: `<div align="center" style="color:white;border-radius:5px;background-color:${color};padding:2px">${name}</div>`,
          iconSize: [55],
          popupAnchor: [0, -5],
        });
      }
      return iconCache[key];
    }

    function getMarkerColor(temp, ext, timestamp) {
      const ageMin = (Date.now() - new Date(timestamp).getTime()) / 60000;
      if (ageMin > 15) return "black";
      if (limits.T1max !== null && temp >= limits.T1max) return "red";
      if (limits.T1min !== null && temp <= limits.T1min) return "blue";
      return "green";
    }

    function getCombinedMarkerColor(t1, t2, timestamp) {
      const now = Date.now();
      const ageMin = (now - new Date(timestamp).getTime()) / 60000;

      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ ‚Äî —á–µ—Ä–Ω—ã–∏ —Ü–≤–µ—Ç
      if (ageMin > 15 || (isNaN(t1) && isNaN(t2))) return "black";

      const over =
        (t1 != null && !isNaN(t1) && t1 > limits.T1max) ||
        (t2 != null && !isNaN(t2) && t2 > limits.T2);

      const under =
        t1 != null &&
        !isNaN(t1) &&
        t1 < limits.T1min &&
        t2 != null &&
        !isNaN(t2) &&
        t2 < 35;

      if (over) return "red";
      if (under) return "blue";
      return "green";
    }

    function updateMarkersColors() {
      if (Date.now() - lastBulkUpdate < 10000) return;
      lastBulkUpdate = Date.now();

      fetch("/api/live_temp_bulk/")
        .then((res) => res.json())
        .then((data) => {
          Object.entries(pumpMarkers).forEach(([name, marker]) => {
            const normalizedName = name.toLowerCase().replace(/^pt_/, ""); // ‚¨ÖÔ∏è —É–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å PT_
            const temps = data[normalizedName];
            if (!temps) return;

            const t1 = parseFloat(temps.T1);
            const t2 = parseFloat(temps.T2);
            const timestamp = temps.timestamp || new Date().toISOString();

            const color = getCombinedMarkerColor(t1, t2, timestamp);

            marker.setIcon(getColoredIcon(name, color));
          });
        })
        .catch((err) => console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤:", err));
    }

    function fetchExteriorTemp() {
      fetch("/api/temperature_limits")
        .then((res) => res.json())
        .then((data) => {
          limits = data;
          exteriorTemp = data.Text;
          updateMarkersColors();

          document.getElementById("limits-tooltip").style.whiteSpace = "pre";
          document.getElementById("limits-tooltip").textContent =
            `Text = ${limits.Text}¬∞C    T1min = ${limits.T1min}¬∞C    T1max = ${limits.T1max}¬∞C    T2 = ${limits.T2}¬∞C    Tacm = ${limits.Tacm}¬∞C`;
        })
        .catch((err) => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–º–∏—Ç–æ–≤:", err));
    }

    // üëá –î–û–ë–ê–í–õ–Ø–ï–ú –°–†–ê–ó–£ –ü–û–°–õ–ï getColoredIcon()
    function getBoilerIcon(type) {
      switch (type) {
        case 3:
          return "sp.png"; // –ö–æ—Ç–µ–ª—å–Ω—ã–µ SP
        case 4:
          return "disp.png"; // –î–∏—Å–ø–µ—Ç—á–µ—Ä—Å–∫–∏–µ
        case 5:
          return "verde.png"; // CET —Å —Ç—Ä—É–±–æ–π
        default:
          return "sp.png"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
      }
    }

    function fetchAndRenderPumps() {
      if (window.pumpsLoaded) return;
      window.pumpsLoaded = true;
      fetch("/api/pumps/")
        .then((res) => res.json())
        .then((data) => {
          data.forEach((pump) => {
            const type = pump.type_device === 1 ? "PTC" : "PTI";
            const t1Display =
              pump.T1 == null || isNaN(pump.T1) ? "N" : pump.T1;
            const t2Display =
              pump.T2 == null || isNaN(pump.T2) ? "N" : pump.T2;

            const marker = L.marker([pump.lat, pump.longitude], {
              icon: getColoredIcon(pump.param_name, "green"),
              number_map: pump.number_map,
            }).bindPopup(
              `<b>${type}</b><br><b>${pump.param_name.replace(/^PT_/i, "")}</b><br>${pump.address}<br><b>T1:</b> ${t1Display} ¬∞C<br><b>T2:</b> ${t2Display} ¬∞C<br>
                        <a href='http://10.1.1.174/view/view_page.php?title=${encodeURIComponent(pump.param_name.replace(/\./g, "").replace("PT_", ""))}' target='_blank'>Schema</a>`,
            );

            marker.on("click", () => {
              fetch(`/api/live_temp/${pump.param_name}/`)
                .then((r) => r.json())
                .then((data) => {
                  const popup = marker.getPopup();
                  let content = popup.getContent();
                  const t1Live =
                    data.T1 == null || isNaN(data.T1) ? "N" : data.T1;
                  const t2Live =
                    data.T2 == null || isNaN(data.T2) ? "N" : data.T2;
                  content = content
                    .replace(/<b>T1:<\/b>[^<]*¬∞C/, `<b>T1:</b> ${t1Live} ¬∞C`)
                    .replace(/<b>T2:<\/b>[^<]*¬∞C/, `<b>T2:</b> ${t2Live} ¬∞C`);
                  popup.setContent(content).update();
                });
            });

            markers.addLayer(marker);
            pumpMarkers[pump.param_name.toLowerCase().replace(/^pt_/, "")] =
              marker;
          });

          map.addLayer(markers);
          fetchExteriorTemp();
          setInterval(fetchExteriorTemp, 60000);
        });
    }

    const boilerLayer = L.layerGroup().addTo(map); // –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π –¥–ª—è –∫–æ—Ç–µ–ª—å–Ω—ã—Ö

    fetch("/api/boilers/")
      .then((res) => res.json())
      .then((data) => {
        data.forEach((boiler) => {
          const iconFile = getBoilerIcon(boiler.type_device);

// –∫–ª–∞—Å—Å –ø–æ —Ç–∏–ø—É
const cls =
  boiler.type_device === 3 ? "sp" :
  boiler.type_device === 4 ? "disp" :
  boiler.type_device === 5 ? "ct" : "sp";

const icon = L.divIcon({
  className: "",
  html: `
    <div class="station-ico ${cls}">
      <img class="base" src="/static/icons/${iconFile}" alt="station">

      ${cls === "sp"   ? `<div class="rotor"></div>` : ``}
      ${cls === "disp" ? `<div class="blink"></div>` : ``}

      ${cls === "ct" ? `<img class="smoke" src="/static/icons/factory_smoke_full.gif" alt="smoke">` : ``}
    </div>
  `,
  iconSize: [48, 48],
  iconAnchor: [24, 48],
  popupAnchor: [0, -48],
});


          // --- –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≤ –ø–æ–ø–∞–ø ---
          const marker = L.marker([boiler.latitude, boiler.longitude], {
            icon: icon,
            title: boiler.name_device,
            number_map: boiler.sector_id || 0,
          }).bindPopup(`
                <b>${boiler.name_device}</b><br>
                ${boiler.address}<br>
                <i>${boiler.param_name}</i><br>
                <b>T1:</b> ... ¬∞C<br>
                <b>T2:</b> ... ¬∞C
                `);

          // --- –ü–æ –∫–ª–∏–∫—É –≥—Ä—É–∑–∏–º live-–¥–∞–Ω–Ω—ã–µ –∏–º–µ–Ω–Ω–æ –¥–ª—è –∫–æ—Ç–µ–ª—å–Ω—ã—Ö ---
          marker.on("click", () => {
            fetch(`/api/live_temp_boiler/${boiler.param_name}/`)
              .then((r) => r.json())
              .then((data) => {
                const popup = marker.getPopup();
                let content = popup.getContent();
                const t1Live =
                  data.T1 == null || isNaN(data.T1) ? "N" : data.T1;
                const t2Live =
                  data.T2 == null || isNaN(data.T2) ? "N" : data.T2;
                content = content
                  .replace(/<b>T1:<\/b>[^<]*¬∞C/, `<b>T1:</b> ${t1Live} ¬∞C`)
                  .replace(/<b>T2:<\/b>[^<]*¬∞C/, `<b>T2:</b> ${t2Live} ¬∞C`);
                popup.setContent(content).update();
              })
              .catch((err) =>
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∫–æ—Ç–µ–ª—å–Ω–æ–π:", err),
              );
          });

          boilerLayer.addLayer(marker); // –∫–æ—Ç–µ–ª—å–Ω—ã–µ –ù–ï –∏–¥—É—Ç –≤ –∫–ª–∞—Å—Ç–µ—Ä!
        });
      });

    function searchObject() {
      const query = $("#search-box")
        .val()
        .trim()
        .toLowerCase()
        .replace(/^pt_/, "");
      saveSearchQuery(query);
      markers.clearLayers();

      if (!query) {
        Object.values(pumpMarkers).forEach((m) => markers.addLayer(m));
        if (markers.getLayers().length) map.fitBounds(markers.getBounds());
        return;
      }

      const variants = [query];

      for (const variant of variants) {
        const marker = pumpMarkers[variant];
        if (marker) {
          markers.addLayer(marker);
          map.setView(marker.getLatLng(), 16);
          marker.openPopup();

          // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          fetch(`/api/live_temp/${variant}/`)
            .then((r) => r.json())
            .then((data) => {
              const popup = marker.getPopup();
              let content = popup.getContent();

              const t1Live =
                data.T1 == null || isNaN(data.T1) ? "N" : data.T1;
              const t2Live =
                data.T2 == null || isNaN(data.T2) ? "N" : data.T2;

              content = content
                .replace(/<b>T1:<\/b>[^<]*¬∞C/, `<b>T1:</b> ${t1Live} ¬∞C`)
                .replace(/<b>T2:<\/b>[^<]*¬∞C/, `<b>T2:</b> ${t2Live} ¬∞C`);

              popup.setContent(content).update();
            })
            .catch((err) => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err));

          return;
        }
      }

      alert("Obiectul nu a fost gƒÉsit!");
    }

    function saveSearchQuery(query) {
      if (!query) return;
      let history = JSON.parse(localStorage.getItem("searchHistory")) || [];
      if (!history.includes(query)) {
        history.push(query);
        localStorage.setItem("searchHistory", JSON.stringify(history));
        updateSearchHistoryList();
      }
    }

    function updateSearchHistoryList() {
      let history = JSON.parse(localStorage.getItem("searchHistory")) || [];
      $("#search-history").empty();
      history.forEach((item) => {
        $("#search-history").append(`<option value="${item}">`);
      });
    }

    $(document).ready(function () {
      updateSearchHistoryList();
      $("#search-button").click(searchObject);
      $("#search-box").keypress((e) => {
        if (e.which === 13) searchObject();
      });
      $("#search-box").on("input", function () {
        if (!$(this).val().trim()) {
          markers.clearLayers();
          Object.values(pumpMarkers).forEach((marker) =>
            markers.addLayer(marker),
          );
          if (markers.getLayers().length) map.fitBounds(markers.getBounds());
        }
      });

      const box = document.getElementById("limits-box");
      const tooltip = document.getElementById("limits-tooltip");

      box.addEventListener("mouseenter", () => {
        tooltip.classList.remove("hidden");
      });
      box.addEventListener("mouseleave", () => {
        tooltip.classList.add("hidden");
      });
    });

    function focusSector(sector) {
      markers.clearLayers();
      Object.values(pumpMarkers).forEach((marker) => {
        if (sector === 0 || marker.options.number_map === sector)
          markers.addLayer(marker);
      });
      if (markers.getLayers().length) map.fitBounds(markers.getBounds());
    }

    // === –¶–≤–µ—Ç–∞ –æ–±–≤–æ–¥–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ —Å–µ–∫—Ç–æ—Ä–æ–≤
    const sectorButtonColors = {
      1: "red", // Centru
      2: "purple", // Rascani
      3: "green", // Botanica
      4: "orange", // Buiucani
      6: "blue", // Ciocana
      0: "white", // AratƒÉ Toate
    };

    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º
    document.querySelectorAll("#sector-buttons button").forEach((button) => {
      button.addEventListener("click", function () {
        const sectorNumber = parseInt(this.dataset.sector);

        const sectorMap = {
          1: "Centru",
          2: "Riscani",
          3: "Botanica",
          4: "Buiucani",
          6: "Ciocana",
          0: "AratƒÉ Toate",
        };

        const sectorName = sectorMap[sectorNumber];

        markers.clearLayers();
        Object.values(sectorPolygons).forEach((polygon) =>
          map.removeLayer(polygon),
        );

        if (sectorName === "AratƒÉ Toate") {
          Object.values(pumpMarkers).forEach((marker) =>
            markers.addLayer(marker),
          );
          Object.values(sectorPolygons).forEach((polygon) =>
            polygon.addTo(map),
          );
          if (markers.getLayers().length) map.fitBounds(markers.getBounds());
        } else {
          Object.entries(pumpMarkers).forEach(([name, marker]) => {
            if (marker.options.number_map === sectorNumber)
              markers.addLayer(marker);
          });

          sectorPolygons[sectorName].addTo(map);
          if (markers.getLayers().length) map.fitBounds(markers.getBounds());
        }

        // –û—á–∏—Å—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll("#sector-buttons button").forEach((btn) => {
          btn.classList.remove("active");
          btn.style.borderColor = "#bbb";
        });

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–∞ –æ–±–≤–æ–¥–∫–∏ –ø–æ —Å–µ–∫—Ç–æ—Ä—É
        const color = sectorButtonColors[sectorNumber] || "gray";
        this.classList.add("active");
        this.style.borderColor = color;
      });
    });

    const filterIcons = document.querySelectorAll(".filter-icon");
    const statusList = document.getElementById("status-list");

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ —Å–ø–∏—Å–∫–∞
    document.addEventListener("click", (event) => {
      if (
        !event.target.closest("#status-filter") &&
        !event.target.closest("#status-list")
      ) {
        statusList.classList.add("hidden");
      }
    });

    filterIcons.forEach((icon) => {
      icon.addEventListener("click", (event) => {
        event.stopPropagation(); // –ù–µ –¥–∞—ë–º –≤—Å–ø–ª—ã—Ç–∏—é –∑–∞–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫

        const color = icon.dataset.color;
        statusList.innerHTML = "";

        const matchingMarkers = Object.entries(pumpMarkers).filter(
          ([name, marker]) =>
            marker.options.icon.options.html.includes(
              `background-color:${color}`,
            ),
        );

        if (matchingMarkers.length === 0) {
          statusList.innerHTML = "<i>Nu sunt obiecte!</i>";
        } else {
          matchingMarkers.forEach(([name, marker]) => {
            const item = document.createElement("div");
            item.textContent = name.toUpperCase();

            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–≤–µ—Ç –∏–∑ HTML –∏–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–µ—Ä–∞
            const iconHtml = marker.options.icon.options.html;
            const colorMatch = iconHtml.match(/background-color:([^;"]+)/);
            const markerColor = colorMatch ? colorMatch[1].trim() : "#000";

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∫ —Ç–µ–∫—Å—Ç—É
            item.style.color = markerColor;

            item.onclick = () => {
              markers.clearLayers();
              markers.addLayer(marker);
              map.setView(marker.getLatLng(), 16);
              marker.openPopup();
              fetch(`/api/live_temp/${name}/`)
                .then((r) => r.json())
                .then((data) => {
                  const popup = marker.getPopup();
                  let content = popup.getContent();
                  const t1Live =
                    data.T1 == null || isNaN(data.T1) ? "N" : data.T1;
                  const t2Live =
                    data.T2 == null || isNaN(data.T2) ? "N" : data.T2;
                  content = content
                    .replace(/<b>T1:<\/b>[^<]*¬∞C/, `<b>T1:</b> ${t1Live} ¬∞C`)
                    .replace(/<b>T2:<\/b>[^<]*¬∞C/, `<b>T2:</b> ${t2Live} ¬∞C`);
                  popup.setContent(content).update();
                })
                .catch((err) =>
                  console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err),
                );
            };

            statusList.appendChild(item);
          });
        }

        statusList.classList.remove("hidden");
      });
    });

    fetch("/api/get_ip/")
      .then((response) => response.json())
      .then((data) => {
        console.log("IP –∞–¥—Ä–µ—Å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:", data.ip);
      });

    function fetchAndRenderPipelines() {
      if (window.pipelinesLoaded) return;
      window.pipelinesLoaded = true;
      fetch("{% static 'data/vitiku.geojson' %}")
        .then((response) => {
          if (!response.ok)
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å vitiku.geojson");
          return response.json();
        })
        .then((geojsonData) => {
          heatPipelineLayer = L.geoJSON(geojsonData, {
            style: {
              color: "blue",
              weight: 3,
              opacity: 0.85,
            },
            onEachFeature: function (feature, layer) {
              layer.bindPopup("–¢–µ–ø–ª–æ—Ç—Ä–∞—Å—Å–∞");
            },
          });
          // –î–æ–±–∞–≤–ª—è—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑—É–º >= 18
          if (map.getZoom() >= 18) {
            heatPipelineLayer.addTo(map);
          }
          // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å, –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ zoomend!
        });
    }

    function fetchAndRenderZadvisca() {
      if (window.zadviscaLoaded) return;
      window.zadviscaLoaded = true;
      fetch("/static/data/zadvisca.geojson")
        .then((response) => response.json())
        .then((geojson) => {
          zadviscaLayer = L.geoJSON(geojson, {
            pointToLayer: (feature, latlng) => {
              return L.circleMarker(latlng, {
                radius: 6,
                color: "black",
                fillColor: "yellow",
                fillOpacity: 0.7,
              });
            },
            onEachFeature: function (feature, layer) {
              const props = feature.properties;
              let popupHtml = `<b>${props.name_node || ""}</b><br>`;
              if (props.consumer_purpose)
                popupHtml += `${props.consumer_purpose}<br>`;
              if (props.NUMOBJ) popupHtml += `ID: ${props.NUMOBJ}<br>`;
              layer.bindPopup(popupHtml);
            },
          });
          // –î–æ–±–∞–≤–ª—è—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑—É–º >= 18
          if (map.getZoom() >= 18) {
            zadviscaLayer.addTo(map);
          }
          // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å, –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ zoomend!
        });
    }
</script>
</body>
</html>
